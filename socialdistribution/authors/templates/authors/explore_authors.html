{% extends "base.html" %}
{% block title %}Explore Authors{% endblock %}
{% block content %}
<div class="card profile-card">
    <div class="profile-header">
        <div class="profile-meta">
            <h1 class="profile-username">Explore Authors</h1>
        </div>
    </div>
    
    <div class="profile-section">
        <div id="authors-list">
            <p>Loading authors...</p>
        </div>
    </div>
    
    <div style="margin-top: 16px;">
        <a href="{% url 'stream' %}" style="color: #1E90FF;">← Return to Stream</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetchAuthors();
});

async function fetchAuthors() {
    try {
        const response = await fetch('/api/authors/explore/', {
            credentials: 'include'
        });
        
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        renderAuthors(data.all || []);
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('authors-list').innerHTML = 
            '<p style="color: red;">Failed to load authors. Make sure you are logged in.</p>';
    }
}

function renderAuthors(authors) {
    const container = document.getElementById('authors-list');
    
    if (!authors || authors.length === 0) {
        container.innerHTML = '<p>No authors found.</p>';
        return;
    }
    
    const authorItems = authors.map(author => {
        const isRemote = author._is_remote || false;
        
        // Get correct field names from the SPEC
        const authorId = author.id || '';
        const displayName = author.displayName || 'Unknown';  // ← Only displayName exists in spec
        const profileImage = author.profileImage || '';
        
        // Badge styling - make it inline and not cramped
        const badge = isRemote ? 
            `<span style="background: #17a2b8; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">${author._node_name || 'Remote'}</span>` : 
            '<span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">Local</span>';
        
        return `
        <li class="entry-item">
            <div class="entry-item-left">
                ${profileImage ? 
                    `<img src="${profileImage}" alt="${displayName}"
                        style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="profile-avatar placeholder"
                        style="width: 40px; height: 40px; border-radius: 50%; background: #ddd;
                                display: none; align-items: center; justify-content: center; flex-shrink: 0;">
                        ${displayName.charAt(0).toUpperCase()}
                    </div>` :
                    `<div class="profile-avatar placeholder"
                        style="width: 40px; height: 40px; border-radius: 50%; background: #ddd;
                                display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        ${displayName.charAt(0).toUpperCase()}
                    </div>`
                }
                <div class="author-text">
                    <h3>${displayName}</h3>
                </div>
                ${badge}
            </div>

            <button onclick="followAuthor('${authorId}', '${displayName.replace(/'/g, "\\'")}', this)"
                    style="background-color: #1E90FF; color: white; padding: 8px 20px;
                        border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                Follow
            </button>
        </li>
    `;
    }).join('');
    
    container.innerHTML = `<ul class="entry-list" style="list-style: none; padding: 0; margin: 0;">${authorItems}</ul>`;
}

async function followAuthor(authorId, displayName, button) {
    if (!authorId) {
        alert('Invalid author ID');
        return;
    }
    
    if (!confirm(`Send follow request to ${displayName}?`)) {
        return;
    }
    
    // Disable button during request
    button.disabled = true;
    button.textContent = 'Sending...';
    
    try {
        const response = await fetch('/api/authors/follow/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({ author_id: authorId })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`✅ Follow request sent to ${displayName}!`);
            button.textContent = 'Sent';
            button.style.backgroundColor = '#28a745';
        } else {
            alert(`❌ ${data.detail}`);
            button.disabled = false;
            button.textContent = 'Follow';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to send follow request');
        button.disabled = false;
        button.textContent = 'Follow';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<style>
  /* Layout for each author row */
  #authors-list .entry-list {
      list-style: none;
      margin: 0;
      padding: 0;
  }

  #authors-list .entry-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      padding: 12px 0;
  }

  #authors-list .entry-item-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
      flex: 1;
  }

  #authors-list .entry-item-left .author-text {
      display: flex;
      flex-direction: column;
      min-width: 0;
  }

  #authors-list .entry-item-left .author-text h3 {
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
  }

  #authors-list .entry-item-left .author-text p {
      margin: 0;
      color: #666;
  }

  #authors-list .entry-item button {
      width: auto !important;
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
      white-space: nowrap;
  }
</style>

{% endblock %}