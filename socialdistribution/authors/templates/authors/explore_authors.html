{% extends "base.html" %}
{% block title %}Explore Authors{% endblock %}
{% block content %}
<div class="card profile-card">
    <div class="explore-header">
        <h1>Explore Authors</h1>
        <p>Discover and follow authors from your node and beyond</p>
    </div>
    
    <div id="authors-list">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading authors...</p>
        </div>
    </div>
    
    <div style="margin-top: 16px;">
        <a href="{% url 'stream' %}" style="color: #1E90FF;">← Return to Stream</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetchAuthors();
});

async function fetchAuthors() {
    try {
        const response = await fetch('/api/authors/explore/', {
            credentials: 'include'
        });
        
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        
        // Fetch follow status for all authors
        const authorsWithStatus = await Promise.all(
            (data.all || []).map(async (author) => {
                const followStatus = await checkFollowStatus(author.id);
                return { ...author, followStatus };
            })
        );
        
        renderAuthors(authorsWithStatus);
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('authors-list').innerHTML = 
            '<p style="color: red;">Failed to load authors. Make sure you are logged in.</p>';
    }
}

async function checkFollowStatus(authorId) {
    try {
        // Extract UUID from full URL if needed
        const uuid = authorId.split('/').filter(Boolean).pop();
        
        const response = await fetch(`/api/authors/${uuid}/follow-status/`, {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            return data.status; // 'following', 'pending', 'not_following'
        }
    } catch (error) {
        console.error('Error checking follow status:', error);
    }
    return 'not_following';
}

function renderAuthors(authors) {
    const container = document.getElementById('authors-list');
    
    if (!authors || authors.length === 0) {
        container.innerHTML = '<p>No authors found.</p>';
        return;
    }
    
    const authorItems = authors.map(author => {
        const isRemote = author._is_remote || false;
        const authorId = author.id || '';
        const displayName = author.displayName || 'Unknown';
        const profileImage = author.profileImage || '';
        
        const badge = isRemote ? 
            `<span style="background: #17a2b8; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">${author._node_name || 'Remote'}</span>` : 
            '<span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">Local</span>';
        
        // Determine button based on follow status
        let buttonHtml = '';
        if (author.followStatus === 'following') {
            buttonHtml = `
                <button onclick="unfollowAuthor('${authorId}', '${displayName.replace(/'/g, "\\'")}', this)" 
                        style="background-color: #c62828; color: white; padding: 8px 20px;
                            border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    Unfollow
                </button>
            `;
        } else if (author.followStatus === 'pending') {
            buttonHtml = `
                <button disabled
                        style="background-color: #ef6c00; color: white; padding: 8px 20px;
                            border: none; border-radius: 4px; cursor: not-allowed; font-size: 14px;">
                    Pending
                </button>
            `;
        } else {
            buttonHtml = `
                <button onclick="followAuthor('${authorId}', '${displayName.replace(/'/g, "\\'")}', this)" 
                        style="background-color: #1E90FF; color: white; padding: 8px 20px;
                            border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    Follow
                </button>
            `;
        }
        
        return `
        <li class="entry-item">
            <div class="entry-item-left">
                ${profileImage ? 
                    `<img src="${profileImage}" alt="${displayName}"
                        style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="profile-avatar placeholder"
                        style="width: 40px; height: 40px; border-radius: 50%; background: #ddd;
                                display: none; align-items: center; justify-content: center; flex-shrink: 0;">
                        ${displayName.charAt(0).toUpperCase()}
                    </div>` :
                    `<div class="profile-avatar placeholder"
                        style="width: 40px; height: 40px; border-radius: 50%; background: #ddd;
                                display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        ${displayName.charAt(0).toUpperCase()}
                    </div>`
                }
                <div class="author-text">
                    <h3>${displayName}</h3>
                </div>
                ${badge}
            </div>
            ${buttonHtml}
        </li>
    `;
    }).join('');
    
    container.innerHTML = `<ul class="entry-list" style="list-style: none; padding: 0; margin: 0;">${authorItems}</ul>`;
}

async function followAuthor(authorId, displayName, button) {
    if (!authorId) {
        alert('Invalid author ID');
        return;
    }
    
    if (!confirm(`Send follow request to ${displayName}?`)) {
        return;
    }
    
    button.disabled = true;
    button.textContent = 'Sending...';
    
    try {
        const response = await fetch('/api/authors/follow/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({ author_id: authorId })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`✅ ${data.detail}`);
            // Refresh the list to update button states
            fetchAuthors();
        } else {
            alert(`❌ ${data.detail}`);
            button.disabled = false;
            button.textContent = 'Follow';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to send follow request');
        button.disabled = false;
        button.textContent = 'Follow';
    }
}

async function unfollowAuthor(authorId, displayName, button) {
    if (!confirm(`Unfollow ${displayName}?`)) {
        return;
    }
    
    button.disabled = true;
    button.textContent = 'Unfollowing...';
    
    try {
        // Extract UUID from full URL
        const uuid = authorId.split('/').filter(Boolean).pop();
        
        const response = await fetch(`/api/authors/${uuid}/unfollow/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`✅ Unfollowed ${displayName}`);
            // Refresh the list to update button states
            fetchAuthors();
        } else {
            alert(`❌ ${data.detail || 'Failed to unfollow'}`);
            button.disabled = false;
            button.textContent = 'Unfollow';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to unfollow');
        button.disabled = false;
        button.textContent = 'Unfollow';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.container {
      max-width: 800px !important; 
      width: 100%;
      margin-left: auto;
      margin-right: auto;
  }
  .explore-header {
      text-align: center;
      padding-bottom: 24px;
      margin-bottom: 24px;
      border-bottom: 1px solid #eee;
  }

  .explore-header h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: #333;
  }

  .explore-header p {
      margin: 0;
      color: #666;
      font-size: 14px;
  }

  .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      color: #666;
  }

  .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #eee;
      border-top-color: #1E90FF;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
  }

  @keyframes spin {
      to { transform: rotate(360deg); }
  }

  #authors-list .entry-list {
      list-style: none;
      margin: 0;
      padding: 0;
  }

  #authors-list .entry-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    padding: 16px;
    margin-bottom: 12px;
    background: #f8f9fa;
    border-radius: 12px;
}

#authors-list .entry-item:last-child {
    margin-bottom: 0;
}

  #authors-list .entry-item-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
      flex: 1;
  }

  #authors-list .entry-item-left .author-text {
      display: flex;
      flex-direction: column;
      min-width: 0;
  }

  #authors-list .entry-item-left .author-text h3 {
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
  }

  #authors-list .entry-item button {
      width: auto !important;
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
      white-space: nowrap;
  }
</style>

{% endblock %}