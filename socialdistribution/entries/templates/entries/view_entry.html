{% extends "base.html" %}

{% block title %}{{ entry.title }} - Social Distribution{% endblock %}

{% block content %}
<style>
    .container {
        max-width: 1000px;
        margin: 40px auto 0;
        padding: 0 20px;
    }

    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 20px;
        position: relative;
    }

    /* Back button top-right */
    .btn-back {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #f5f5f5;
        color: #333;
        border-radius: 4px;
        padding: 10px 20px;
        text-decoration: none;
        font-size: 14px;
    }
    .btn-back:hover {
        background-color: #e0e0e0;
    }

    .entry-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .entry-actions a,
    .entry-actions button {
        flex: 1;
        min-width: 120px;
        padding: 10px 0;
        border-radius: 4px;
        text-decoration: none;
        font-size: 14px;
        cursor: pointer;
        text-align: center;
        border: none;
    }

    .btn-like { background-color: #28a745; color: white; }
    .btn-like:hover { background-color: #218838; }

    .btn-edit,.btn-edit:visited { background-color: #1E90FF; color: white; }
    .btn-edit:hover { background-color: #187bcd; }

    .btn-delete { background-color: #f44336; color: white; }
    .btn-delete:hover { background-color: #da190b; }

    .btn-share, .copy-btn {
        background-color: #6c757d;
        color: white;
    }
    .btn-share:hover, .copy-btn:hover {
        background-color: #5a6268 !important;
    }
    .btn-edit:hover {
        background-color: #187bcd;
    }

    .btn-delete, .btn-delete:visited {
        background-color: #f44336;
        color: white;
        border: none;
    }
    .btn-delete:hover {
        background-color: #da190b;
    }

    .btn-back, .btn-back:visited {
        background-color: #f5f5f5;
        color: #333;
    }
    .btn-back:hover {
        background-color: #e0e0e0;
    }

    .visibility-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        margin-left: 8px;
        font-size: 12px;
        font-weight: 500;
    }
    .badge-public { background-color: #e8f5e9; color: #2e7d32; }
    .badge-friends { background-color: #fff3e0; color: #e65100; }
    .badge-unlisted { background-color: #e3f2fd; color: #1565c0; }
    .comments-section {
        margin-top: 30px;
        border-top: 1px solid #eee;
        padding-top: 24px;
    }
    .comments-section h3 {
        margin-bottom: 16px;
    }
    .comment-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 20px;
    }
    .comment {
        padding: 12px 16px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    .comment-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        font-size: 13px;
        color: #555;
    }
    .comment-like-form {
        display: inline;
    }
    .comment-like-form button {
        background: none;
        border: none;
        color: #1E90FF;
        cursor: pointer;
        font-weight: 500;
        padding: 0;
    }
    .comment-like-form button:hover {
        text-decoration: underline;
    }
    .comment-header {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: #555;
        margin-bottom: 8px;
    }
    .comment-body {
        white-space: pre-wrap;
        color: #333;
    }
    .comment-form textarea {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        font-family: inherit;
        resize: vertical;
    }
    .comment-form button {
        margin-top: 10px;
        background-color: #1E90FF;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 4px;
        cursor: pointer;
    }
    .comment-form button:hover {
        background-color: #187bcd;
    }
    .comment-note {
        font-size: 13px;
        color: #666;
        margin-bottom: 12px;
    }
    .entry-actions > * {
    flex: 1;
    min-width: 120px;
    }

    .entry-actions form {
    display: flex !important;
    align-items: stretch;
    }

    .entry-actions form button {
    flex: 1;
    height: 100%;
    }

</style>

<div class="card">
    <div class="entry-header">
        <h2>{{ entry.title }}</h2>
        <div class="entry-meta">
            By 
            <a href="{{ entry.author.get_absolute_url }}">
                {{ entry.author.display_name }}
            </a> â€¢ {{ entry.published|date:"F d, Y" }} â€¢ {{ entry.liked_by.count }} Likes
            {% if entry.visibility == 'PUBLIC' %}
                <span class="visibility-badge badge-public">Public</span>
            {% elif entry.visibility == 'FRIENDS' %}
                <span class="visibility-badge badge-friends">Friends Only</span>
            {% elif entry.visibility == 'UNLISTED' %}
                <span class="visibility-badge badge-unlisted">Unlisted</span>
            {% endif %}
        </div>
        {% if entry.description %}
            <p style="color: #666; margin-top: 10px;">{{ entry.description }}</p>
        {% endif %}
    </div>

    {% load markdown_extras %}

    <div class="entry-content">
        {% if entry.content_type == 'text/markdown' %}
            <!-- Render markdown as HTML -->
            {{ entry.content|render_markdown|safe }}
        
        {% elif entry.content_type == 'text/plain' %}
            <!-- Display plain text with line breaks -->
            <pre>{{ entry.content }}</pre>
        
        {% elif "image" in entry.content_type %}
            <img src="data:{{ entry.content_type }};base64,{{ entry.content }}" 
                 alt="{{ entry.title }}"
                 class="img-fluid">
        
        {% else %}
            <!-- Fallback -->
            {{ entry.content }}
        {% endif %}
    </div>
    
    <div class="likes-section" style="margin-top: 20px; font-size: 0.95em;">
        {% if entry.liked_by.all %}
            {% if entry.liked_by.count > 0 %}
                <p><strong>Liked by:</strong>
                    {% for user in entry.liked_by.all %}
                        <a href="{{ user.get_absolute_url }}">
                            {{ user.display_name }}
                        </a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
            {% else %}
                <p>No likes yet.</p>
            {% endif %}
        {% else %}
            <p>No likes yet.</p>
        {% endif %}
    </div>
    
    <div class="entry-actions">
        <form method="post" action="{% url 'entries:like_entry' entry.id %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn-like">Like ({{ entry.likes_count }})</button>
        </form>
        {% if request.user.id == entry.author.id %}
            <a href="{% url 'entries:edit_entry' entry.id %}" class="btn-edit">Edit</a>
            <form method="get" action="{% url 'entries:delete_entry' entry.id %}" style="display:inline-block;">
                <button type="submit" class="btn-delete">Delete</button>
            </form>
        {% endif %}
        <a href="{% url 'stream' %}" class="btn-back">Back to Stream</a>
        {% if entry.visibility == 'PUBLIC' or entry.visibility == 'UNLISTED' %}
            <button type="submit" class="btn-share" onclick="copyEntryURL('{{ request.build_absolute_uri }}')">
                Share
            </button>
        {% endif %}
        {% if "image" in entry.content_type and image_url %}
            <button type="button" 
                    onclick="copyImageURL('{{ image_url }}')"
                    class="copy-btn btn-share">
                ðŸ“‹ Copy Image Link
            </button>
        {% endif %}
    </div>
    
    <script>
    function copyImageURL(url) {
        navigator.clipboard.writeText(url)
            .then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ“ Copied!';
                btn.style.background = '#28a745 !important';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#1E90FF !important';
                }, 1500);
            })
            .catch(err => {
                console.error("Failed to copy: ", err);
                alert("Failed to copy link");
            });
    }
    
    function copyEntryURL(url) {
        navigator.clipboard.writeText(url)
            .then(() => {
                alert("Entry URL copied to clipboard!");
            })
            .catch(err => {
                console.error("Failed to copy: ", err);
            });
    }
    </script>

    <div class="comments-section">
        <h3>Comments</h3>
        {% if is_friend_view %}
        <p class="comment-note">Only you and {{ entry.author.display_name }} can view your comments on this entry.</p>
        {% endif %}
        {% if comments %}
        <ul class="comment-list">
            {% for comment in comments %}
            <li class="comment">
                <div class="comment-header">
                    <span>{{ comment.author.display_name }}</span>
                    <span>{{ comment.created_at|date:"F j, Y g:i a" }}</span>
                </div>
                <div class="comment-body">{{ comment.content }}</div>
                <div class="comment-footer">
                    <span>{{ comment.likes_count }} like{{ comment.likes_count|pluralize }}</span>
                    {% if request.user.is_authenticated %}
                        {% if request.user == comment.author or request.user == entry.author %}
                        <form method="post" action="{% url 'entries:like_comment' comment.id %}" class="comment-like-form">
                            {% csrf_token %}
                            <button type="submit">Like</button>
                        </form>
                        {% endif %}
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No comments yet. Be the first to respond.</p>
        {% endif %}

        {% if request.user.is_authenticated %}
        <form method="post" action="{% url 'entries:add_comment' entry.id %}" class="comment-form">
            {% csrf_token %}
            {{ comment_form.non_field_errors }}
            {{ comment_form.content.errors }}
            {{ comment_form.content }}
            <button type="submit">Post Comment</button>
        </form>
        {% else %}
        <p><a href="{% url 'authors:login' %}?next={{ request.path }}">Log in</a> to write a comment.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
